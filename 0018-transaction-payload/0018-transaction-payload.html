<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0018-transaction-payload - The IOTA Protocol RFC Book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../0005-white-flag/0005-white-flag.html">0005-white-flag</a></li><li class="chapter-item expanded "><a href="../0008-uniform-random-tip-selection/0008-uniform-random-tip-selection.html">0008-uniform-random-tip-selection</a></li><li class="chapter-item expanded "><a href="../0012-milestone-merkle-validation/0012-milestone-merkle-validation.html">0012-milestone-merkle-validation</a></li><li class="chapter-item expanded "><a href="../0015-binary-to-ternary-encoding/0015-binary-to-ternary-encoding.html">0015-binary-to-ternary-encoding</a></li><li class="chapter-item expanded "><a href="../0017-tangle-message/0017-tangle-message.html">0017-tangle-message</a></li><li class="chapter-item expanded "><a href="../0018-transaction-payload/0018-transaction-payload.html" class="active">0018-transaction-payload</a></li><li class="chapter-item expanded "><a href="../0019-milestone-payload/0019-milestone-payload.html">0019-milestone-payload</a></li><li class="chapter-item expanded "><a href="../0020-bech32-address-format/0020-bech32-address-format.html">0020-bech32-address-format</a></li><li class="chapter-item expanded "><a href="../0024-message-pow/0024-message-pow.html">0024-message-pow</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The IOTA Protocol RFC Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Feature name: transaction_payload</li>
<li>Start date: 2020-07-10</li>
<li>RFC PR: <a href="https://github.com/iotaledger/protocol-rfcs/pull/18">iotaledger/protocol-rfcs#18</a></li>
</ul>
<h1 id="summary"><a class="header" href="#summary">Summary</a></h1>
<p>This RFC defines a new transaction structure for Chrysalis Phase 2, which replaces the current notion of bundles. Specifically, this RFC proposes a transaction payload for the messages described in the IOTA protocol <a href="https://iotaledger.github.io/protocol-rfcs/0017-tangle-message/0017-tangle-message.html">RFC-0017</a>.</p>
<h1 id="motivation"><a class="header" href="#motivation">Motivation</a></h1>
<p>The current IOTA protocol uses <strong>transactions</strong> (which are vertices in the Tangle), where each transaction defines either an input or output. A grouping of those input/output transaction vertices make up a <strong>bundle</strong> which transfers the given values as an atomic unit (the entire bundle is applied or none of it). The input transactions define the funds to consume and create the deposits onto the output transactions target addresses. Additionally, to accommodate the larger WOTS signatures, additional transaction vertices might be part of the bundle to carry parts of the signature which do not fit into one transaction vertex.</p>
<p>The bundle concept has proven to be time consuming, with several issues as well:</p>
<ul>
<li>Since the data making up the bundle is split across multiple vertices, it complicates the validation of the entire transfer. Instead of being able to immediately tell whether a bundle is valid or not, a node implementation must first collect all parts of the bundle before any actual validation can happen. This increases the complexity of the node implementation.</li>
<li>Reattaching the tail transaction of a bundle causes the entire transfer to be reapplied.</li>
<li>Due to the split across multiple transaction vertices and having to do PoW for each of them, a bundle might already be lazy in terms of where it attaches, reducing its chances to be confirmed.</li>
</ul>
<p>To fix the problems mentioned above and to create a more flexible transaction structure, the goal is to achieve a self-contained transaction structure defining the data of the entire transfer as a payload to be embedded into a message.</p>
<p>The new transaction structure should fulfil the following criteria:</p>
<ul>
<li>Support for Ed25519 (and thus reusable addresses).</li>
<li>Support for adding new types of signature schemes, addresses, inputs, and outputs as part of protocol upgrades.</li>
<li>Self-contained, as in being able to validate the transaction immediately after receiving it.</li>
<li>Enable unspent transaction outputs (UTXO) as inputs instead of an account based model (UTXO enables easier double-spend detection).</li>
</ul>
<h1 id="detailed-design"><a class="header" href="#detailed-design">Detailed design</a></h1>
<h2 id="utxo"><a class="header" href="#utxo">UTXO</a></h2>
<p>The <em>unspent transaction output</em> (UTXO) model defines a ledger state where balances are not directly associated to addresses but to the outputs of transactions. In this model, transactions specify the outputs of previous transactions as inputs, which are consumed to create new outputs. A transaction must consume the entirety of the specified inputs.</p>
<p>Using an UTXO based model provides several benefits:</p>
<ul>
<li>Parallel validation of transactions.</li>
<li>Easier double-spend detection, since conflicting transactions would reference the same UTXO.</li>
<li>Replay-protection which is important when having reusable addresses. Replaying the same transaction would manifest itself as already being applied or existent and thus not have any impact.</li>
<li>Technically seen, balances may no longer be associated to addresses which raises the level of abstraction and thus enables other types of outputs. Consider, for example, a type of output which specifies the balance to be unlocked by a transaction which must fulfil a Proof-of-Work difficulty or supply some other unlock criteria, etc.</li>
</ul>
<p>Within a transaction using UTXOs, inputs and outputs make up the to-be-signed data of the transaction. The section unlocking the inputs is called <em>unlock block</em>. An unlock block may contain a signature proving ownership of a given input's address and/or other unlock criteria.</p>
<p>The following image depicts the flow of funds using UTXO:</p>
<p><img src="img/utxo.png" alt="UTXO flow" /></p>
<p>The way UTXOs are referenced is further described in the <i>Structure</i> section of this RFC.</p>
<h2 id="structure"><a class="header" href="#structure">Structure</a></h2>
<h3 id="serialized-layout"><a class="header" href="#serialized-layout">Serialized Layout</a></h3>
<p>A <i>Transaction Payload</i> payload is made up of two parts:</p>
<ol>
<li>The <i>The Transaction Essence</i> part which contains the inputs, outputs and an optional embedded payload.</li>
<li>The <i>Unlock Blocks</i> which unlock the <i>Transaction Essence</i>'s inputs. In case the unlock block contains a signature, it signs the entire <i>Transaction Essence</i> part.</li>
</ol>
<p>All values are serialized in little-endian encoding. The serialized form of the transaction is deterministic, meaning the same logical transaction always results in the same serialized byte sequence.</p>
<p>A <code>Blake2b-256</code> hash of the entire serialized data makes up <i>Transaction Payload</i>'s ID.</p>
<p>Following table structure describes the entirety of a <i>Transaction Payload</i>'s serialized form:</p>
<ul>
<li>Data Type Notation, see <a href="https://iotaledger.github.io/protocol-rfcs/0017-tangle-message/0017-tangle-message.html#data-types">RFC-0017</a></li>
<li><details>
  <summary>Subschema Notation</summary>
  <table>
      <tr>
          <th>Name</th>
          <th>Description</th>
      </tr>
      <tr>
          <td><code>oneOf</code></td>
          <td>One of the listed subschemas.</td>
      </tr>
      <tr>
          <td><code>optOneOf</code></td>
          <td>Optionally one of the listed subschemas.</td>
      </tr>
      <tr>
          <td><code>anyOf</code></td>
          <td>Any (one or more) of the listed subschemas.</td>
      </tr>
  </table>
</li>
</ul>
</details>
<p></p>
<table>
    <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
    </tr>
    <tr>
        <td>Payload Type</td>
        <td>uint32</td>
        <td>
            Set to <strong>value 0</strong> to denote a <i>Transaction Payload</i>.
        </td>
    </tr>
    <tr>
        <td valign="top">Essence <code>oneOf</code></td>
        <td colspan="2">
            <details open="true">
                <summary>Transaction Essence</summary>
                <blockquote>
                    Describes the essence data making up a transaction by defining its inputs and outputs and an optional payload.
                </blockquote>
                <table>
                    <tr>
                        <td><b>Name</b></td>
                        <td><b>Type</b></td>
                        <td><b>Description</b></td>
                    </tr>
                    <tr>
                        <td>Transaction Type</td>
                        <td>uint8</td>
                        <td>
                            Set to <strong>value 0</strong> to denote a <i>Transaction Essence</i>.
                        </td>
                    </tr>
                    <tr>
                        <td>Inputs Count</td>
                        <td>uint16</td>
                        <td>The amount of inputs proceeding.</td>
                    </tr>
                    <tr>
                        <td valign="top">Inputs <code>anyOf</code></td>
                        <td colspan="2">
                            <details>
                                <summary>UTXO Input</summary>
                                <blockquote>
                                    Describes an input which references an unspent transaction output to consume.
                                </blockquote>
                                <table>
                                    <tr>
                                        <td><b>Name</b></td>
                                        <td><b>Type</b></td>
                                        <td><b>Description</b></td>
                                    </tr>
                                    <tr>
                                        <td>Input Type</td>
                                        <td>uint8</td>
                                        <td>
                                            Set to <strong>value 0</strong> to denote an <i>UTXO Input</i>.
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Transaction ID</td>
                                        <td>Array&lt;byte&gt;[32]</td>
                                        <td>The BLAKE2b-256 hash of the transaction from which the UTXO comes from.</td>
                                    </tr>
                                    <tr>
                                        <td>Transaction Output Index</td>
                                        <td>uint16</td>
                                        <td>The index of the output on the referenced transaction to consume.</td>
                                    </tr>
                                </table>
                            </details>
                        </td>
                    </tr>
                    <tr>
                        <td>Outputs Count</td>
                        <td>uint16</td>
                        <td>The amount of outputs proceeding.</td>
                    </tr>
                    <tr>
                        <td valign="top">Outputs <code>anyOf</code></td>
                        <td colspan="2">
                            <details>
                                <summary>SigLockedSingleOutput</summary>
                                <blockquote>
                                    Describes a deposit to a single address which is unlocked via a signature.
                                </blockquote>
                                <table>
                                    <tr>
                                        <td><b>Name</b></td>
                                        <td><b>Type</b></td>
                                        <td><b>Description</b></td>
                                    </tr>
                                    <tr>
                                        <td>Output Type</td>
                                        <td>uint8</td>
                                        <td>
                                            Set to <strong>value 0</strong> to denote a <i>SigLockedSingleOutput</i>.
                                        </td>
                                    </tr>
                                    <tr>
                                        <td valign="top">Address <code>oneOf</code></td>
                                        <td colspan="2">
                                            <details>
                                                <summary>Ed25519 Address</summary>
                                                <table>
                                                    <tr>
                                                        <td><b>Name</b></td>
                                                        <td><b>Type</b></td>
                                                        <td><b>Description</b></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Address Type</td>
                                                        <td>uint8</td>
                                                        <td>
                                                            Set to <strong>value 0</strong> to denote an <i>Ed25519 Address</i>.
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Address</td>
                                                        <td>Array&lt;byte&gt;[32]</td>
                                                        <td>The raw bytes of the Ed25519 address which is a BLAKE2b-256 hash of the Ed25519 public key.</td>
                                                    </tr>
                                                </table>
                                            </details>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Amount</td>
                                        <td>uint64</td>
                                        <td>The amount of tokens to deposit.</td>
                                    </tr>
                                </table>
                            </details>
                            <details>
                                <summary>SigLockedDustAllowanceOutput</summary>
                                <blockquote>
                                    Describes a deposit which as a special property also alters the dust allowance of the target address.
                                </blockquote>
                                <table>
                                    <tr>
                                        <td><b>Name</b></td>
                                        <td><b>Type</b></td>
                                        <td><b>Description</b></td>
                                    </tr>
                                    <tr>
                                        <td>Output Type</td>
                                        <td>uint8</td>
                                        <td>
                                            Set to <strong>value 1</strong> to denote a <i>SigLockedDustAllowanceOutput</i>.
                                        </td>
                                    </tr>
                                    <tr>
                                        <td valign="top">Address <code>oneOf</code></td>
                                        <td colspan="2">
                                            <details>
                                                <summary>Ed25519 Address</summary>
                                                <table>
                                                    <tr>
                                                        <td><b>Name</b></td>
                                                        <td><b>Type</b></td>
                                                        <td><b>Description</b></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Address Type</td>
                                                        <td>uint8</td>
                                                        <td>
                                                            Set to <strong>value 0</strong> to denote an <i>Ed25519 Address</i>.
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Address</td>
                                                        <td>Array&lt;byte&gt;[32]</td>
                                                        <td>The raw bytes of the Ed25519 address which is a BLAKE2b-256 hash of the Ed25519 public key.</td>
                                                    </tr>
                                                </table>
                                            </details>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Amount</td>
                                        <td>uint64</td>
                                        <td>The amount of tokens to deposit.</td>
                                    </tr>
                                </table>
                            </details>
                        </td>
                    </tr>
                    <tr>
                        <td>Payload Length</td>
                        <td>uint32</td>
                        <td>The length in bytes of the optional payload.</td>
                    </tr>
                    <tr>
                        <td valign="top">Payload <code>optOneOf</code></td>
                        <td colspan="2">
                            <details>
                                <summary>Generic Payload</summary>
                                <blockquote>
                                    An outline of a generic payload
                                </blockquote>
                                <table>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                    </tr>
                                    <tr>
                                        <td>Payload Type</td>
                                        <td>uint32</td>
                                        <td>
                                            The type of the payload. It will instruct the node how to parse the fields that follow.
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Data Fields</td>
                                        <td>ANY</td>
                                        <td>A sequence of fields, where the structure depends on <code>Payload Type</code>.</td>
                                    </tr>
                                </table>
                            </details>
                    <tr>
                </table>
            </details>
        </td>
    </tr>
    <tr>
        <td>Unlock Blocks Count</td>
        <td>uint16</td>
        <td>The count of unlock blocks proceeding. Must match count of inputs specified.</td>
    </tr>
    <tr>
        <td valign="top">Unlock Blocks <code>anyOf</code></td>
        <td colspan="2">
            <details open="true">
                <summary>Signature Unlock Block</summary>
                <blockquote>
                    Defines an unlock block containing signature(s) unlocking input(s).
                </blockquote>
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td>Unlock Type</td>
                        <td>uint8</td>
                        <td>
                            Set to <strong>value 0</strong> to denote a <i>Signature Unlock Block</i>.
                        </td>
                    </tr>
                    <tr>
                        <td valign="top">Signature <code>oneOf</code></td>
                        <td colspan="2">
                            <details>
                                <summary>Ed25519 Signature</summary>
                                <table>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                    </tr>
                                    <tr>
                                        <td>Signature Type</td>
                                        <td>uint8</td>
                                        <td>
                                            Set to <strong>value 0</strong> to denote an <i>Ed25519 Signature</i>.
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Public key</td>
                                        <td>Array&lt;byte&gt;[32]</td>
                                        <td>The public key of the Ed25519 keypair which is used to verify the signature.</td>
                                    </tr>
                                    <tr>
                                        <td>Signature</td>
                                        <td>Array&lt;byte&gt;[64]</td>
                                        <td>The signature signing the Blake2b-256 hash of the serialized <i>Transaction Essence</i>.</td>
                                    </tr>
                                </table>
                            </details>
                        </td>
                    </tr>
                </table>
            </details>
            <details open="true">
                <summary>Reference Unlock Block</summary>
                <blockquote>
                    References a previous unlock block in order to substitute the duplication of the same unlock block data for inputs which unlock through the same data.
                </blockquote>
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td>Unlock Type</td>
                        <td>uint8</td>
                        <td>
                            Set to <strong>value 1</strong> to denote a <i>Reference Unlock Block</i>.
                        </td>
                    </tr>
                    <tr>
                        <td>Reference</td>
                        <td>uint16</td>
                        <td>Represents the index of a previous unlock block.</td>
                    </tr>
                </table>
            </details>
        </td>
    </tr>
</table>
<h3 id="transaction-parts"><a class="header" href="#transaction-parts">Transaction Parts</a></h3>
<p>In general, all parts of a <i>Transaction Payload</i> begin with a byte describing the type of the given part to keep the flexibility to introduce new types/versions of the given part in the future.</p>
<h4 id="transaction-essence-data"><a class="header" href="#transaction-essence-data">Transaction Essence Data</a></h4>
<p>As described, the <i>Transaction Essence</i> of a <i>Transaction Payload</i> carries the inputs, outputs, and an optional payload. The <i>Transaction Essence</i> is an explicit type and therefore starts with its own <i>Transaction Essence Type</i> byte which is of value 0.</p>
<p>A <i>Transaction Essence</i> must contain at least one input and output.</p>
<h5 id="inputs"><a class="header" href="#inputs">Inputs</a></h5>
<p>The <i>Inputs</i> part holds the inputs to consume, respectively, to fund the outputs of the <i>Transaction Essence</i>. There is only one type of input as of now, the <i>UTXO Input</i>. In the future, more types of inputs may be specified as part of protocol upgrades.</p>
<p>Each defined input must be accompanied by a corresponding <i>Unlock Block</i> at the same index in the <i>Unlock Blocks</i> part of the <i>Transaction Payload</i>.</p>
<p>If multiple inputs can be unlocked through the same <i>Unlock Block</i>, then the given <i>Unlock Block</i> only needs to be specified at the index of the first input which gets unlocked by it.</p>
<p>Subsequent inputs which are unlocked through the same data must have a <i>Reference Unlock Block</i> pointing to the index of a previous <i>Unlock Block</i>.
This ensures that no duplicate data needs to occur in the same transaction.</p>
<h6 id="utxo-input"><a class="header" href="#utxo-input">UTXO Input</a></h6>
<p>An <i>UTXO Input</i> is an input which references an output of a previous transaction by using the given transaction's BLAKE2b-256 hash + the index of the output on that transaction. An <i>UTXO Input</i> must be accompanied by an <i>Unlock Block</i> for the corresponding type of output the <i>UTXO Input</i> is referencing.</p>
<p>Example: If the output the input references outputs to an Ed25519 address, then the corresponding unlock block must be of type <i>Signature Unlock Block</i> holding an Ed25519 signature.</p>
<h5 id="outputs"><a class="header" href="#outputs">Outputs</a></h5>
<p>The <i>Outputs</i> part holds the outputs to create with this <i>Transaction Payload</i>.</p>
<h6 id="siglockedsingleoutput"><a class="header" href="#siglockedsingleoutput">SigLockedSingleOutput</a></h6>
<p>The <i>SigLockedSingleOutput</i> defines an output (with a certain amount) to a single target address which is unlocked via a signature proving ownership over the given address. This output can hold addresses of different types.</p>
<h6 id="siglockeddustallowanceoutput"><a class="header" href="#siglockeddustallowanceoutput">SigLockedDustAllowanceOutput</a></h6>
<p>The <i>SigLockedDustAllowanceOutput</i> works the same as a <i>SigLockedSingleOutput</i> but additionally controls the dust allowance on the target address. See <a href="https://github.com/iotaledger/protocol-rfcs/pull/32">Dust Protection RFC-0032 (draft)</a> for further information.</p>
<h5 id="payload"><a class="header" href="#payload">Payload</a></h5>
<p>The  <em>Transaction Essence</em> itself can contain another payload as described in general in <a href="https://iotaledger.github.io/protocol-rfcs/0017-tangle-message/0017-tangle-message.html">RFC-0017</a>. This payload does not affect the semantic validity of the <i>Transaction Essence</i>. If the transaction is not syntactically valid, then the payload must also be discarded.</p>
<p>The following table lists all the payloads types that can be nested inside a <em>Transaction Essence</em> as well as links to the corresponding specification:</p>
<table><thead><tr><th>Name</th><th>Type Value</th><th>RFC</th></tr></thead><tbody>
<tr><td>Indexation</td><td>2</td><td><a href="https://iotaledger.github.io/protocol-rfcs/0017-tangle-message/0017-tangle-message.html#indexation-payload">RFC-0017</a></td></tr>
</tbody></table>
<h4 id="unlock-blocks"><a class="header" href="#unlock-blocks">Unlock Blocks</a></h4>
<p>The <i>Unlock Blocks</i> part holds the unlock blocks unlocking inputs within an <i>Transaction Essence</i>.</p>
<p>There are different types of <i>Unlock Blocks</i>:</p>
<table><thead><tr><th>Name</th><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td>Signature Unlock Block</td><td>0</td><td>An unlock block holding one or more signatures unlocking one or more inputs.</td></tr>
<tr><td>Reference Unlock Block</td><td>1</td><td>An unlock block which must reference a previous unlock block which unlocks also the input at the same index as this Reference Unlock Block.</td></tr>
</tbody></table>
<h5 id="signature-unlock-block"><a class="header" href="#signature-unlock-block">Signature Unlock Block</a></h5>
<p>A <i>Signature Unlock Block</i> defines an <i>Unlock Block</i> which holds one or more signatures signing the Blake2b-256 hash of the <i>Transaction Essence</i> (including the optional payload).</p>
<h5 id="reference-unlock-block"><a class="header" href="#reference-unlock-block">Reference Unlock block</a></h5>
<p>A <i>Reference Unlock Block</i> defines an <i>Unlock Block</i> which references a previous <i>Unlock Block</i> (which must not be another <i>Reference Unlock Block</i>). It must be used if multiple inputs can be unlocked through the same origin <i>Unlock Block</i>.</p>
<p>Example:
Consider an <i>Transaction Essence</i> containing <i>UTXO Inputs</i> A, B and C, where A and C are both spending the UTXOs originating from the same Ed25519 address. The <i>Unlock Block</i> part must thereby have following structure:</p>
<table><thead><tr><th>Index</th><th>Must Contain</th></tr></thead><tbody>
<tr><td>0</td><td>A <i>Signature Unlock Block</i> holding the corresponding Ed25519 signature to unlock A and C.</td></tr>
<tr><td>1</td><td>A <i>Signature Unlock Block</i> which unlocks B.</td></tr>
<tr><td>2</td><td>A <i>Reference Unlock Block</i> which references index 0, since C also gets unlocked by the same signature as A.</td></tr>
</tbody></table>
<h2 id="validation"><a class="header" href="#validation">Validation</a></h2>
<p>A <i>Transaction Payload</i> payload has different validation stages, since some validation steps can only be executed at the point when certain information has (or has not) been received. We therefore distinguish between syntactical- and semantic validation.</p>
<h3 id="syntactical-validation"><a class="header" href="#syntactical-validation">Syntactical Validation</a></h3>
<p>This validation can commence as soon as the transaction data has been received in its entirety. It validates the structure but not the signatures of the transaction. If the transaction does not pass this stage, it must not be broadcasted further and can be discarded right away.</p>
<p>The following criteria defines whether the transaction passes the syntactical validation:</p>
<ul>
<li>Essence:
<ul>
<li><code>Transaction Type</code> value must be 0, denoting an <code>Transaction Essence</code>.</li>
<li>Inputs:
<ul>
<li><code>Inputs Count</code> must be 0 &lt; x ≤ 127.</li>
<li>At least one input must be specified.</li>
<li><code>Input Type</code> value must be 0, denoting an <code>UTXO Input</code>.</li>
<li><code>UTXO Input</code>:
<ul>
<li><code>Transaction Output Index</code> must be 0 ≤ x &lt; 127.</li>
<li>Every combination of <code>Transaction ID</code> + <code>Transaction Output Index</code> must be unique in the inputs set.</li>
</ul>
</li>
<li>Inputs must be sorted in lexicographical order of their serialized form.<sup>1</sup></li>
</ul>
</li>
<li>Outputs:
<ul>
<li><code>Outputs Count</code> must be 0 &lt; x ≤ 127.</li>
<li>At least one output must be specified.</li>
<li><code>Output Type</code> must denote a <code>SigLockedSingleOutput</code> or <code>SigLockedDustAllowanceOutput</code>.</li>
<li><code>SigLockedSingleOutput</code>/<code>SigLockedDustAllowanceOutput</code>:
<ul>
<li><code>Address Type</code> must be 0, denoting an <code>Ed25519</code> address.</li>
<li>The <code>Address</code> must be unique in the set of <code>SigLockedSingleOutputs</code>/<code>SigLockedDustAllowanceOutputs</code> (two separate sets).</li>
<li><code>Amount</code> must be larger than zero.</li>
</ul>
</li>
<li>Outputs must be sorted in lexicographical order by their serialized form.<sup>1</sup></li>
<li>Accumulated output balance must not exceed the total supply of tokens <code>2'779'530'283'277'761</code>.</li>
</ul>
</li>
<li>Payload (if present):
<ul>
<li><code>Payload Type</code> must match one of the values described under <a href="#payload">Payload</a>.</li>
<li><code>Data fields</code> must be correctly parsable in the context of the <code>Payload Type</code>.</li>
<li>The payload itself must pass syntactic validation.</li>
</ul>
</li>
</ul>
</li>
<li>Unlock Blocks:
<ul>
<li><code>Unlock Blocks Count</code> must match <code>Inputs Count</code> of the <em>Transaction Essence</em>.</li>
<li><code>Unlock Type</code> must either be 0 or 1, denoting a <code>Signature Unlock Block</code> or <code>Reference Unlock block</code>.</li>
<li><code>Signature Unlock Blocks</code> must define a <code>Ed25519 Signature</code>.</li>
<li>A <code>Signature Unlock Block</code> unlocking multiple inputs must only appear once (be unique) and be positioned at the same index of the first input it unlocks. All other inputs unlocked by the same <code>Signature Unlock Block</code> must have a companion <code>Reference Unlock Block</code> at the same index as the corresponding input which points to the origin <code>Signature Unlock Block</code>.</li>
<li><code>Reference Unlock Blocks</code> must specify a previous <code>Unlock Block</code> which is not of type <code>Reference Unlock Block</code>. The reference index must therefore be &lt; the index of the <code>Reference Unlock Block</code>.</li>
</ul>
</li>
<li>Given the type and length information, the <em>Transaction Payload</em> must consume the entire byte array of the <code>Payload</code> field of the encapsulating object.</li>
</ul>
<p><sup>1</sup> ensures that serialization of the transaction becomes deterministic, meaning that libraries always produce the same bytes given the logical transaction.</p>
<h3 id="semantic-validation"><a class="header" href="#semantic-validation">Semantic Validation</a></h3>
<p>Semantic validation starts when a message that is part of a confirmation cone of a milestone is processed in the <a href="https://iotaledger.github.io/protocol-rfcs/0005-white-flag/0005-white-flag.html#deterministically-ordering-the-tangle">White-Flag ordering</a>. Semantics are only validated during White-Flag confirmations to enforce an ordering that can be understood by all the nodes (i.e. milestone cones), no matter the order the transactions are received. Otherwise, if semantic validation would occur as soon as a transaction would be received, it could potentially lead to nodes having different views of the UTXOs available to spend.</p>
<p>Processing transactions in the White-Flag ordering enables users to spend UTXOs which are in the same milestone confirmation cone, if their transaction comes after the funding transaction in the mentioned White-Flag ordering. It is recommended that users spending unconfirmed UTXOs attach their message directly onto the message containing the source transaction.</p>
<p>The following criteria defines whether the transaction passes the semantic validation:</p>
<ol>
<li>The UTXOs the transaction references must be known (booked) and unspent.</li>
<li>The transaction is spending the entirety of the funds of the referenced UTXOs to the outputs.</li>
<li>The address type of the referenced UTXO must match the signature type contained in the corresponding <i>Signature Unlock Block</i>.</li>
<li>The <i>Signature Unlock Blocks</i> are valid, i.e. the signatures prove ownership over the addresses of the referenced UTXOs.</li>
</ol>
<p>If a transaction passes the semantic validation, its referenced UTXOs must be marked as spent and the corresponding new outputs must be booked/specified in the ledger. The booked transaction then also becomes part of the White-Flag Merkle tree inclusion set.</p>
<p>Transactions which do not pass semantic validation are ignored. Their UTXOs are not marked as spent and neither are their outputs booked into the ledger.</p>
<h2 id="miscellaneous"><a class="header" href="#miscellaneous">Miscellaneous</a></h2>
<h3 id="absent-transaction-timestamp"><a class="header" href="#absent-transaction-timestamp">Absent transaction timestamp</a></h3>
<p>A transaction timestamp whether signed or not, does not actually tell when the transaction was issued. Therefore, the timestamp has been left out from the transaction structure. The correct way to determine the issuance time is to use a combination of the solidification and confirmation timestamps of the message embedding the transaction.</p>
<h3 id="how-to-compute-the-balance"><a class="header" href="#how-to-compute-the-balance">How to compute the balance</a></h3>
<p>Since the ledger is no longer account based, meaning that balances are directly mapped to addresses, computing the balance involves iterating over all UTXOs where their destination address is the address in question and then accumulating their amounts.</p>
<h3 id="reusing-the-same-address-with-ed25519"><a class="header" href="#reusing-the-same-address-with-ed25519">Reusing the same address with Ed25519</a></h3>
<p>While creating multiple signatures with Ed25519 does not reduce security, repeatedly reusing the same address not only drastically reduces the privacy of users but also all other people in the UTXO chain of the moved funds. Applications and services are then instructed to create new addresses per deposit, to circumvent the privacy issues stemming from address reuse.
In essence, Ed25519 support allows for smaller transaction sizes and to safely spend funds which were sent to an already used deposit address.
Ed25519 addresses are not meant to be used like an e-mail address. See this <a href="https://en.bitcoin.it/wiki/Address_reuse#:%7E:text=The%20most%20private%20and%20secure,a%20brand%20new%20bitcoin%20address.">Bitcoin wiki entry</a> for further information on how address reuse reduces privacy and this <a href="https://en.bitcoin.it/wiki/Receiving_donations_with_bitcoin">article</a> on why the same should be applied to donation addresses.</p>
<h1 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h1>
<p>The new transaction format is the core data type within the IOTA ecosystem. Changing it means that all projects need to accommodate for it, including client libraries, blueprints, PoC, and applications using IOTA in general. There is no way to keep the changes backwards compatible. Additionally, these changes are breaking, meaning that all nodes must upgrade to further participate in the network.</p>
<p>Additionally, local snapshots can no longer be represented by a list of addresses and their balances, since the ledger is now made up of the UTXOs on which the actual funds reside on. Therefore, local snapshot file schemes have to be adjusted to incorporate the transaction hashes, output indices, and then the destination addresses including the balances.</p>
<h1 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h1>
<p>Introducing this new transaction structure allows for further extensions in the future, to accommodate new requirements. With the support for Ed25519 addresses/signatures, transaction size is drastically reduced and allows for safe re-signing in case funds appear to be deposited onto a previous generated address. Due to the switch to a complete binary transaction, size is further reduced, saving network bandwidth and processing time.</p>
<p>Other transaction structures have been considered but they would have misused existing transaction fields to accommodate for new features, instead of putting them into a proper descriptive structure. Additionally, those ideas would not have been safe against replay attacks, which deems reusing the old transaction structure, for example for Ed25519 addresses/signatures, as infeasible.</p>
<p>Not switching to the new transaction structure described in this RFC leads to people being open to loss of funds because of WOTS address re-use and not being able to properly extend the protocol further down the line.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../0017-tangle-message/0017-tangle-message.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../0019-milestone-payload/0019-milestone-payload.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../0017-tangle-message/0017-tangle-message.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../0019-milestone-payload/0019-milestone-payload.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
